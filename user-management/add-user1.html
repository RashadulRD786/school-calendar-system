<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Wix+Madefor+Display&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="add-user1.css" />
  </head>
  <body>
    <div class="dashboard-container">
      <header class="dashboard-header">
        <div class="header-left">
          <div class="logo-container">
            <img
              src="../SMKLOGO.png"
              alt="EventFlow Logo"
              class="logo-image"
            />
          </div>
          <div class="header-text">
            <h1 class="company-name">SK SAUJANA UTAMA</h1>
            <p class="company-tagline">Event Management System</p>
          </div>
        </div>
        <div class="welcome-message">Welcome  Admin 👋</div>
        <div class="notification-container">
    <button class="notification-button" data-el="button-1">
        <svg viewBox="0 0 53 58" fill="none" class="notification-icon">
            <rect width="53" height="57" fill="none"></rect>
            <path
                d="M5.58695 34.1858C5.11735 37.3994 7.21688 39.6297 9.78749 40.7412C19.6427 45.0029 33.3574 45.0029 43.2125 40.7412C45.7832 39.6297 47.8827 37.3994 47.4132 34.1858C47.1246 32.2109 45.6975 30.5665 44.6402 28.9608C43.2553 26.8316 43.1178 24.5093 43.1175 22.0386C43.1175 12.4904 35.6777 4.75 26.5 4.75C17.3225 4.75 9.88262 12.4904 9.88262 22.0386C9.8824 24.5093 9.7448 26.8316 8.35993 28.9608C7.30265 30.5665 5.87556 32.2109 5.58695 34.1858Z"
                stroke="#FFFFFF"
                stroke-width="3"
                stroke-linecap="round"
                stroke-linejoin="round"
            ></path>
            <path
                d="M19.875 53.4375C21.6331 54.9145 23.9549 55.8125 26.5 55.8125C29.0451 55.8125 31.3669 54.9145 33.125 53.4375"
                stroke="#FFFFFF"
                stroke-width="3"
                stroke-linecap="round"
                stroke-linejoin="round"
            ></path>
        </svg>
        <span id="notification-badge" style="position:absolute;top:2px;right:2px;background:#ed1c24;color:#fff;font-size:13px;font-weight:600;padding:2px 7px;border-radius:12px;display:none;z-index:11;"></span>
        <div class="notification-dropdown" data-el="div-1" hidden>
            <h3 class="notification-title">Notifications</h3>
            <p class="notification-message">No new notifications</p>
        </div>
    </button>
</div>
      </header>

       <div class="modal view-event-modal" id="view-event-modal" hidden>
    <button class="close-modal-button" id="view-close-button">&times;</button>
    <h2 class="modal-title">Event Details</h2>
    <div class="form-container">
        <div class="form-group">
            <label for="view-name" class="form-label">Event Name</label>
            <input type="text" id="view-name" class="form-input" readonly>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="view-date" class="form-label">Day</label>
                <input type="text" id="view-day" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label for="view-day" class="form-label">Date</label>
                <input type="date" id="view-date" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label for="view-time" class="form-label">Time</label>
                <input type="text" id="view-time" class="form-input" readonly>
            </div>
        </div>
        <div class="form-group">
            <label for="view-location" class="form-label">Location</label>
            <input type="text" id="view-location" class="form-input" readonly>
        </div>
        <div class="form-group">
            <label for="view-involvement" class="form-label">Involvement</label>
            <div id="view-involvement" class="form-input" style="min-height:2em;"></div>
        </div>
        <div class="form-group">
            <label for="view-person" class="form-label">Person in Charge</label>
            <input type="text" id="view-person" class="form-input" readonly>
        </div>
        <div class="form-group">
            <label for="view-unit" class="form-label">Unit</label>
            <input type="text" id="view-unit" class="form-input" readonly>
        </div>
        <div class="form-group">
            <label for="view-status" class="form-label">Status</label>
            <input type="text" id="view-status" class="form-input" readonly>
        </div>
    </div>
</div>

      <div class="dashboard-content">
        <nav class="sidebar">
          <div class="nav-links">
            <a href="../admin-dashboard1.html" class="nav-button dashboard-btn"
            >Dashboard</a
          >
          
          <a href="../report.html" class="nav-button reports-btn">Reports</a>
          <a href="../delete_events.html" class="nav-button reports-btn">Delete Events</a>
          <a href="user-management.php" class="nav-button users-btn active">Admin</a>
        </div>
        <a href="../index.html" class="logout-button">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none">
            <path
              d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
            ></path>
            <path
              d="M16 17L21 12L16 7"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
            ></path>
            <path
              d="M21 12H9"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
            ></path>
          </svg>
          <span>Logout</span>
        </a>
      </nav>

      <main class="main-content">
        <h2 class="section-title">Add User</h2>
        <div class="add-user-content">
          <form action="add-user.php" method="POST" id="addUserForm">
            <div class="form-section">
              <div class="form-group">
                <label>Name</label>
                <input type="text" name="name" class="form-input" id="email" placeholder="Enter name" required />
                <span class="required-message hidden" style="color: red;">Email is required</span>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" class="form-input" id="email" placeholder="Enter email" required />
                <span class="required-message hidden" style="color: red;">Name is required</span>
              </div>
              <div class="form-group">
                <label>Password</label>
                <input type="password" name="password" class="form-input" id="password" placeholder="Enter password" required />
                <span class="required-message hidden" style="color: red;">Password is required</span>
              </div>
              <div class="form-group">
                <label>Role</label>
                <select name="role" class="form-input" id="role" required>
                  <option value="" disabled selected>Select a role</option>
                  <option value="Admin">Admin</option>
                  <option value="Teacher">Teacher</option>
                </select>
                <span class="required-message hidden" style="color: red;">Role is required</span>
              </div>
            </div>
            <div class="form-buttons">
              <button type="submit" class="btn-confirm">Confirm</button>
              <button type="button" class="btn-cancel">Cancel</button>
            </div>
          </form>
        </div>
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    const cancelBtn = document.querySelector('.btn-cancel');
    const form = document.getElementById('addUserForm');
    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const role = document.getElementById('role');
    const requiredMessages = document.querySelectorAll('.required-message');

    // --- START: Notification JS Part Integration ---

    // 1. Define the state object for notifications
    // Combine with any other state you might have for add-user.html if needed
    const state = {
        notifications: false,
        // ... any other state variables specific to your add-user page
    };

    // 2. Event handler for notification button click
    function onButton1Click(event) {
        state.notifications = !state.notifications;
        updateNotificationVisibility(); // Call the specific update function
    }

    // 3. Event handler for notification dropdown click (to close it when clicked inside)
    function onDiv1Click(event) {
        event.stopPropagation(); // Prevents the click from bubbling up to document and closing it
        state.notifications = false; // Set state to hide dropdown
        updateNotificationVisibility(); // Update UI
    }

    // 4. Function to attach notification event listeners
    function setupNotificationListeners() {
        // Attach click listener to the notification icon/button
        document.querySelectorAll("[data-el='button-1']").forEach((el) => {
            el.removeEventListener("click", onButton1Click); // Prevent multiple bindings
            el.addEventListener("click", onButton1Click);
        });

        // Attach click listener to the dropdown itself (to close when clicked inside)
        document.querySelectorAll("[data-el='div-1']").forEach((el) => {
            el.removeEventListener("click", onDiv1Click); // Prevent multiple bindings
            el.addEventListener("click", onDiv1Click);
        });
    }

    // 5. Function to update the visibility of the notification dropdown
    function updateNotificationVisibility() {
        document.querySelectorAll("[data-el='div-1']").forEach((el) => {
            el.hidden = !state.notifications; // Show/hide based on state
        });
    }

    // 6. Optional: Add a click listener to the document to close the dropdown
    // when clicking anywhere else outside of the notification button or dropdown.
    document.addEventListener("click", function (event) {
        const notificationButton = document.querySelector("[data-el='button-1']");
        const notificationDropdown = document.querySelector("[data-el='div-1']");

        // If the dropdown is open AND the click was not on the button AND not inside the dropdown
        if (state.notifications && notificationButton && notificationDropdown &&
            !notificationButton.contains(event.target) && !notificationDropdown.contains(event.target)) {
            state.notifications = false;
            updateNotificationVisibility();
        }
    });

    // --- END: Notification JS Part Integration ---


    // Existing form submission logic
    form.addEventListener('submit', (e) => {
        let valid = true;
        requiredMessages.forEach(msg => msg.classList.add('hidden'));

        if (!email.value.trim()) {
            document.querySelector('#email + .required-message').classList.remove('hidden');
            valid = false;
        }

        if (!password.value.trim()) {
            document.querySelector('#password + .required-message').classList.remove('hidden');
            valid = false;
        }

        if (!role.value.trim()) {
            document.querySelector('#role + .required-message').classList.remove('hidden');
            valid = false;
        }

        if (!valid) {
            e.preventDefault(); // Stop form submission if invalid
        }
    });

    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            window.location.href = 'user-management.php';
        });
    }

    // Call the notification setup functions when the DOM is ready
    setupNotificationListeners();
    updateNotificationVisibility(); // Set initial visibility (hidden by default)
});

// --- Notification Dropdown Toggle Logic ---
    // This part handles showing/hiding the notification dropdown when the bell icon is clicked.
    document.querySelector('.notification-button').addEventListener('click', function(event) {
        const dropdown = document.querySelector('.notification-dropdown');
        dropdown.hidden = !dropdown.hidden;
        event.stopPropagation(); // Prevent immediate closing from window click listener
    });

    // Close dropdown if clicked anywhere outside the notification container
    document.addEventListener('click', function(event) {
        const notificationContainer = document.querySelector('.notification-container');
        const dropdown = document.querySelector('.notification-dropdown');
        if (!notificationContainer.contains(event.target) && !dropdown.hidden) {
            dropdown.hidden = true;
        }
    });


    // --- Event Detail Modal Logic (#view-event-modal) ---
    let currentEventId = null; // To keep track of the event ID being viewed

    // Function to fetch and display event details in the new modal
    function viewEventDetails(eventId) {
        fetch('../get_event_by_id.php?id=' + eventId) // Fetches event data from PHP
            .then(res => {
                if (!res.ok) {
                    // If the HTTP response status is not 2xx (e.g., 404, 500)
                    // Throw an error with the status for the catch block to handle
                    throw new Error(`HTTP error! Status: ${res.status}`);
                }
                return res.json(); // Attempt to parse the response as JSON
            })
            .then(eventDataArray => { // CHANGED: Renamed parameter from 'event' to 'eventDataArray'
                console.log('Event data received (raw array):', eventDataArray);

                // Check if the event data is valid and contains expected data (assuming it's an array)
                if (!eventDataArray || !Array.isArray(eventDataArray) || eventDataArray.length === 0) {
                    console.warn('Received empty or invalid event data for ID:', eventId);
                    alert('⚠️ Event details not found for this notification. It might have been deleted.');
                    document.getElementById('view-event-modal').hidden = true; // Hide modal if no data
                    return; // Stop execution here
                }

                // EXTRACT THE SINGLE EVENT OBJECT:
                const singleEvent = eventDataArray[0]; // CHANGED: Renamed variable from 'event' to 'singleEvent'
                console.log('Processed event object:', singleEvent);

                currentEventId = eventId;

                // Populate the fields of the NEW modal (#view-event-modal)
                // Use 'singleEvent' to access properties
                document.getElementById('view-name').value = singleEvent.name || '';
                document.getElementById('view-day').value = singleEvent.day || '';
                document.getElementById('view-date').value = singleEvent.date || '';
                const formattedTime = formatTimeWithAMPM(singleEvent.time || singleEvent.startTime);
                document.getElementById("view-time").value = formattedTime;
                document.getElementById('view-location').value = singleEvent.location || '';

                document.getElementById('view-person').value = singleEvent.person_in_charge || '';
                document.getElementById('view-unit').value = singleEvent.unit || '';
                document.getElementById('view-status').value = singleEvent.status || '';

                // This part for involvement is correct for a DIV and should remain:
                const involvementContainer = document.getElementById('view-involvement');
                // Check if element exists before manipulating
                if (involvementContainer) {
                    const involvementArr = (singleEvent.involvement || '').split(',').filter(Boolean);
                    involvementContainer.innerHTML = involvementArr.length
                        ? involvementArr.map(name => `<span class="tag">${name.trim()}</span>`).join(' ')
                        : '<span class="tag tag-na">N/A</span>';
                } else {
                    console.warn('Element with ID "view-involvement" not found in the DOM.');
                }

                document.getElementById('view-event-modal').hidden = false;
            })
            .catch(err => {
                // This catch block will now capture errors from network issues AND JSON parsing errors
                console.error('Error fetching or processing event details for ID', eventId, ':', err);

                let errorMessage = '❌ Failed to load event details. ';

                if (err instanceof TypeError && err.message.includes('JSON')) {
                    errorMessage += 'Invalid data received from server. Check get_events.php output.';
                } else if (err.message.startsWith('HTTP error!')) {
                    errorMessage += `Server responded with an error: ${err.message}.`;
                } else {
                    errorMessage += 'Please check the browser console for more information.';
                }
                alert(errorMessage); // Show a user-friendly alert
                document.getElementById('view-event-modal').hidden = true; // Ensure modal is hidden on error
            });
    }

    // Helper function for time formatting
    function formatTimeWithAMPM(timeStr) {
        if (!timeStr) return "N/A";
        const [hours, minutes] = timeStr.split(":").map(Number);
        const ampm = hours >= 12 ? "PM" : "AM";
        const adjustedHour = hours % 12 || 12;
        return `${adjustedHour}:${minutes.toString().padStart(2, "0")} ${ampm}`;
    }

    // Close the NEW modal when 'x' is clicked
    document.getElementById('view-close-button').onclick = function() {
        document.getElementById('view-event-modal').hidden = true;
    };

    // Close the NEW modal when clicking anywhere outside of it
    window.onclick = function(event) {
        const modal = document.getElementById('view-event-modal');
        if (event.target === modal) {
            modal.hidden = true;
        }
    };


    // --- Notification Badge and Dropdown Population Logic ---

    // Function to update the unread notification count badge
    function updateNotificationBadge(count) {
        const badge = document.getElementById('notification-badge');
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }

    // Main function to fetch and display notifications
    function fetchNotifications() {
        fetch('../get_notifications.php') // Fetches notification data from PHP
            .then(res => res.json())
            .then(data => {
                const dropdown = document.querySelector('[data-el="div-1"]');
                const badgeCount = data.unread_count || 0;
                updateNotificationBadge(badgeCount); // Update the badge

                let scrollableDiv = dropdown.querySelector('.notification-scroll');
                let prevScrollTop = scrollableDiv ? scrollableDiv.scrollTop : 0;

                if (data.notifications && data.notifications.length > 0) {
                    // Construct the HTML for notifications within the dropdown
                    dropdown.innerHTML = `
                        <h3 class="notification-title">Notifications</h3>
                        <div style="margin-bottom:10px;text-align:right;">
                            <button id="mark-read-btn" style="background:#008080;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;">Mark all as read</button>
                        </div>
                        <div class="notification-scroll" style="max-height:320px;overflow-y:auto;">
                            ${data.notifications.map(n => `
                                <div class="notification-card" style="background:${n.read ? '#fff' : '#ECECEC'};font-weight:${n.read ? 'normal' : 'bold'};margin-bottom:10px;padding:13px 14px 10px 14px;border-radius:9px;box-shadow:0 2px 8px rgba(32,178,170,0.10);cursor:pointer;transition:box-shadow 0.2s;display:flex;flex-direction:column;gap:4px;">
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <span style="text-align:left;color:#008080;font-size:15px;">New event added: ${n.eventName}</span>
                                    </div>
                                    <div style="display:flex;justify-content:flex-end;align-items:center;margin-top:2px;">
                                        <span style="font-size:12px;color:#888;text-align:right;">${n.eventDate} ${n.eventTime}</span>
                                    </div>
                                    <div style="display:flex;justify-content:flex-end;align-items:center;margin-top:2px;">
                                        <button style="background:none;border:none;color:#20B2AA;font-size:13px;cursor:pointer;padding:0;" onclick="viewEventDetails(${n.eventId})">View Details</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    // Restore scroll position after content update
                    scrollableDiv = dropdown.querySelector('.notification-scroll');
                    if (scrollableDiv) scrollableDiv.scrollTop = prevScrollTop;

                    // Attach event listener for "Mark all as read" button
                    const markBtn = document.getElementById('mark-read-btn');
                    if (markBtn) {
                        markBtn.onclick = function() {
                            fetch('mark_notifications_read.php', { method: 'POST' }) // Request to mark all as read
                                .then(res => res.json())
                                .then(() => fetchNotifications()); // Refresh notifications after marking
                        };
                    }
                } else {
                    // Display "No new notifications" if there are none
                    dropdown.innerHTML = '<h3 class="notification-title">Notifications</h3><p class="notification-message">No new notifications</p>';
                }
            });
    }

    // --- Background Refresh and Initial Load ---
    // Fetch notifications every 1 second (1000ms)
    setInterval(fetchNotifications, 1000);
    // Fetch notifications when the page initially loads
    document.addEventListener('DOMContentLoaded', fetchNotifications);

  </script>
</body>
</html>